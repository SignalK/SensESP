var activeEditors=[],deviceInfo=null,currentPage="info",pagesLoaded=!1,targets={};function ajax(method,url,data,contentType){return new Promise((function(resolve,reject){var request=new XMLHttpRequest;request.open(method,url,!0),request.onload=function(){200===request.status?resolve(request.response):reject(Error(request.statusText))},request.onerror=function(){reject(Error("Network Error"))},contentType&&request.setRequestHeader("Content-Type",contentType),request.send(data)}))}class NavTarget{constructor(key,invokeFunction,link){this.Key=key,this.TargetFunction=invokeFunction,this.Link=link}}function getEmptyContentDiv(){var main=document.getElementById("content");return main.empty(),globalEditor=null,main}function getSingleJsonEditor(element,config,schema){return new JSONEditor(element,{schema:schema,startval:config,no_additional_properties:!0,disable_collapse:!0,disable_properties:!0,disable_edit_json:!0,show_opt_in:!0,theme:"bootstrap4"})}function createEmptyConfigEditorDiv(index){return`\n    <div class='card mb-3'>\n    <div class="card-body">\n    <h5 id='card_title_${index}' class="card-title mb-4">Configuration</h5>\n    <div id='card_description_${index}' class='container ps-0 mb-3'></div>\n    <div id='editor_holder_${index}'></div>\n    <div class='col-12'>\n    <button id='submit_${index}' type='button' class='btn btn-primary mt-3'>Save</button>\n    </div>\n    </div>\n    </div>\n    `}async function loadConfig(configPath){let response=await ajax("GET","/config"+configPath),json=JSON.parse(response);return{config:json.config,schema:json.schema,description:json.description}}function loadAllConfigs(configPaths){return configPaths.map((configPath=>loadConfig(configPath)))}function insertLoaderSpinner(elementId){document.getElementById(elementId).innerHTML='\n    <div id="loader" class="d-flex justify-content-center">\n    <div class="spinner-border" role="status">\n      <span class="visually-hidden">Loading...</span>\n    </div>\n    <span id="loadertext" class="ms-2">Loading...</span>\n    </div>'}function clearLoaderSpinner(element){element.innerHTML=""}async function showSingleConfigEditor(configPath,configDataPromise,index){let configData=await configDataPromise,schema=configData.schema;schema.title||(schema.title=" ");let element=document.getElementById(`editor_holder_${index}`);clearLoaderSpinner(element);let editor=getSingleJsonEditor(element,configData.config,schema);const heading=configPath.substring(1);document.getElementById(`card_title_${index}`).textContent=heading;document.getElementById(`card_description_${index}`).innerHTML=configData.description;return document.getElementById(`submit_${index}`).addEventListener("click",(function(){console.log(index),console.log(deviceInfo.Config[index]),console.log(editor.getValue()),saveConfig(deviceInfo.Config[index],editor.getValue())})),editor}function saveConfig(config_path,values){ajax("PUT","/config"+config_path,JSON.stringify(values),"application/json").then((response=>{alert(`Saved configuration for ${config_path} successfully.`)})).catch((err=>{alert(`Error saving configuration ${config_path}: ${err.message}`)}))}function showConfig(){let main=getEmptyContentDiv();const numConfigs=deviceInfo.Config.length;let configDataPromises=loadAllConfigs(deviceInfo.Config);const cardsHTML=Array.from(Array(numConfigs),((x,i)=>createEmptyConfigEditorDiv(i))).join("\n");main.innerHTML=cardsHTML;for(let i=0;i<numConfigs;i++)insertLoaderSpinner(`editor_holder_${i}`);for(let i=0;i<numConfigs;i++)showSingleConfigEditor(deviceInfo.Config[i],configDataPromises[i],i).then((editor=>{activeEditors.push(editor)}))}function executeCommand(name,shouldConfirm){(1!=shouldConfirm||confirm("Execute "+name+"?"))&&(showLoader(!0,"Executing "+name+"..."),ajax("GET","/command?id="+name).then((r=>{showLoader(!1),alert(r)})).catch((err=>{showLoader(!1),alert(err)})))}function runDeviceCommand(confirmText,command){confirm(confirmText)&&ajax("GET","/device/"+command).then((r=>{alert(r)})).catch((err=>{alert(err)}))}function showControl(){var div=getEmptyContentDiv();if((commands=deviceInfo.Commands).length>0){'<h5 class="card-title my-4">Application commands</h5>\n        <div class="btn-group">';for(var i=0;i<commands.length;i++){`<ยง class="btn btn-primary" onclick="executeCommand('${(command=commands[i]).Name}',${command.Confirm})" href="#">${command.Title}</a>`}"</div>"}var commands,content='\n    <div class=\'card\'>\n        <div class="card-body">\n        <h5 class="card-title mb-4">Device commands</h5>\n        <a href="#" onclick=\'runDeviceCommand("Restart device?", "restart");\' class="btn btn-primary">Restart</a>\n        <a href="#" onclick=\'runDeviceCommand("Are you sure you want to reset device to factory settings?", "reset");\' class="btn btn-danger">Reset to defaults</a>\n        </div>\n    </div>';if((commands=deviceInfo.Commands).length>0){content+="<div class='card mt-3'><div class='card-body'><h5 class='card-title mb-4'>Custom commands</h5>";for(i=0;i<commands.length;i++){var command;content+=`<a class="btn btn-primary" onclick="executeCommand('${(command=commands[i]).Name}',${command.Confirm})" href="#">${command.Title}</a>`}content+="</div></div>"}div.innerHTML=content}function showCustom(target){showLoader(!0),ajax("GET",target.Link).then((v=>{showLoader(!1),getEmptyContentDiv().innerHTML="<h1>"+target.Key+"</h1>"+v})).catch((err=>{showLoader(!1),alert(err)}))}function loadInfo(){ajax("GET","/info").then((response=>{deviceInfo=JSON.parse(response);var content=getEmptyContentDiv(),groups={};for(const property in deviceInfo.Properties){var propertyObj=deviceInfo.Properties[property];propertyObj.Name=property;var group=null;(group=null==groups[propertyObj.Group]?groups[propertyObj.Group]={Name:propertyObj.Group,Properties:[]}:groups[propertyObj.Group]).Properties.push(propertyObj),"Hostname"===property&&(document.getElementById("devicename").innerHTML=propertyObj.Value,document.title=propertyObj.Value+" - WebUI")}for(const key in groups){for((group=groups[key]).Properties.sort(((a,b)=>a.Order-b.Order)),content.innerHTML+=`<div class='col'><h3>${group.Name}</h3>`,i=0;i<group.Properties.length;i++)content.innerHTML+=`<div class='ms-2 mb-3'><label class='form-label'>${group.Properties[i].Name}</label><input type='text' readonly class='form-control' value='${group.Properties[i].Value}'></div>`;content.innerHTML+="</div>"}})).catch((err=>{alert("Device info load failed: "+err.statusText)}))}function initialize(){loadInfo(),targets.status=new NavTarget("status",loadInfo),targets.configuration=new NavTarget("configuration",showConfig),targets.control=new NavTarget("control",showControl),document.getElementById("mainmenu").addEventListener("click",(e=>{var targetKey=e.target.dataset.target,target=targets[targetKey];null!=target&&target.TargetFunction(target)}))}Element.prototype.empty=function(){for(var child=this.lastElementChild;child;)this.removeChild(child),child=this.lastElementChild};